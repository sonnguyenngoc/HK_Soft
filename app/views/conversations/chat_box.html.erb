<!doctype html>
<html lang="en">
	<head>
		<!-- Basic page needs
		============================================ -->
		<title>DacSanVungMien.net | <%= @title_head %></title>
		<%= csrf_meta_tags %>
		<meta charset="utf-8">
		<meta name="author" content="">
		
		<meta name="description" content="<%= @META_DESCRIPTION %>" />
		<meta name="keywords" content="<%= @META_KEYWORDS %>" />
		<meta content='<%= user_signed_in? ? current_user.id : "" %>' name='user-id'/>
		
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
		<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#ffffff">
		<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
		<meta name="theme-color" content="#ffffff">

		<!-- Mobile specific metas
		============================================ -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<!-- Favicon
		============================================ -->
		<%= favicon_link_tag '/frontend/images/fav_icon.ico', rel: 'icon', type: 'image/x-icon' %>

		<!-- Google web fonts
		============================================ -->
		<%= stylesheet_link_tag "http://fonts.googleapis.com/css?family=Roboto:400,400italic,300,300italic,700,700italic,900,900italic" %>

		<!-- Libs CSS
		============================================ -->
		<%= stylesheet_link_tag "/frontend/css/animate.css" %>
		<%= stylesheet_link_tag "/frontend/css/fontello.css" %>
		<%= stylesheet_link_tag "/frontend/css/bootstrap.min.css" %>
		<%= stylesheet_link_tag "/frontend/css/font-awesome.min.css"%>
		<%= stylesheet_link_tag "/frontend/css/font-awesome.css" %>
		
		<!-- Theme CSS
		============================================ -->
		<%= stylesheet_link_tag "/frontend/js/rs-plugin/css/settings.css" %>
		<%= stylesheet_link_tag "/frontend/js/owlcarousel/owl.carousel.css" %>
		<%= stylesheet_link_tag "/frontend/js/arcticmodal/jquery.arcticmodal.css" %>
		<%= stylesheet_link_tag "/frontend/css/style.css" %>
		<%= stylesheet_link_tag "/frontend/stylesheets/custom.css" %>
		<%= stylesheet_link_tag "/frontend/stylesheets/mobile.css" %>
		<%= stylesheet_link_tag "/frontend/stylesheets/chat.css" %>
        <%= stylesheet_link_tag "/frontend/stylesheets/mobile_chat_box.css" %>

		<!-- JS Libs
		============================================ -->
		<%= javascript_include_tag "/frontend/js/modernizr.js" %>
		
		
		<!-- Old IE stylesheet
		============================================ -->
		<!--[if lte IE 9]>
		<%= stylesheet_link_tag '/frontend/css/oldie.css' %>
		<![endif]-->
		
		<!-- JS for Rails -->
		<%= javascript_include_tag 'application' %>
		<!-- /js for rails -->
		
		<!-- Css Product Image Zoom
		============================================ -->
		<%= stylesheet_link_tag '/frontend/js/fancybox/source/jquery.fancybox.css' %>
		<%= stylesheet_link_tag '/frontend/js/fancybox/source/helpers/jquery.fancybox-thumbs.css' %>
		<%= javascript_include_tag "/frontend/js/custom.js" %>
		
		<script>
		
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  
			ga('create', 'UA-77038521-1', 'auto');
			ga('send', 'pageview');
		  
		</script>
		
		<script src='https://www.google.com/recaptcha/api.js?hl=vi'></script>
	</head>
	<body>

		<!-- - - - - - - - - - - - - - Main Wrapper - - - - - - - - - - - - - - - - -->

		<div class="wide_layout">

			<!-- - - - - - - - - - - - - - Page Wrapper - - - - - - - - - - - - - - - - -->

			<div class="secondary_page_wrapper mobile_chat_box_page">

				<div class="container">
					
					<!--<% if current_user.present? %>-->
					<!---->
					<!--	<h5>Xin chào: <%= current_user.first_name.to_s + " " + current_user.last_name.to_s %></h5>-->
					<!--	-->
					<!--	<%= link_to("Đăng xuất", destroy_user_session_path, :method => :delete) %>-->
					<!---->
					<!--<% end %>-->

					<div class="section_offset">

						<div class="row">
							
							<% if user_signed_in? %>

								<section class="col-sm-12">
	
									<!-- - - - - - - - - - - - - - Tabs v2 - - - - - - - - - - - - - - - - -->
	
									<div class="tabs type_2">
	
										<!-- - - - - - - - - - - - - - Navigation of tabs - - - - - - - - - - - - - - - - -->
	
										<ul class="tabs_nav clearfix">
	
											<li><a href="#messages"><i class="fa fa-comments"></i></a></li>
											
											<% if current_user.is_admin == true %>
		
												<li><a href="#users_online"><i class="icon-users"></i></a></li>
												
											<% else %>
												
												<li class="<%= 'active' if params[:new_user] == "true" %>"><a href="#users_online"><i class="icon-users"></i></a></li>
												
											<% end %>
											
											<li>
												
												<a href="#conversations"><i class="icon-history"></i>
													
													<% if current_user.unread_conversations_count > 0 %>
            
														<span class="badge badge-info"><number><%= current_user.unread_conversations_count %></number></span>
											  
													<% end %>
												
												</a>
											
											</li>
	
										</ul>
										
										<!-- - - - - - - - - - - - - - End navigation of tabs - - - - - - - - - - - - - - - - -->
	
										<!-- - - - - - - - - - - - - - Tabs container - - - - - - - - - - - - - - - - -->
	
										<div class="tab_containers_wrap">
	
											<!-- - - - - - - - - - - - - - Tab - - - - - - - - - - - - - - - - -->
	
											<div id="messages" class="tab_container chatbox_tab_container">
	
												<p>Hiện chưa có nội dung chat</p>
	
											</div><!--/ #tab-7-->
	
											<!-- - - - - - - - - - - - - - End tab - - - - - - - - - - - - - - - - -->
											
											<!-- - - - - - - - - - - - - - Tab - - - - - - - - - - - - - - - - -->
	
											<div id="users_online" class="tab_container">
	
												<ul class="list_type_5 chat_box_tabs">
	
													<% if current_user.is_admin == true %>
						
														<% User.get_online_users.each do |user| %>
														
															<% if current_user.id != user.id %>
																
																<li><%= link_to user.first_name.to_s + " " + user.last_name.to_s, "#", class: "start-conversation", "data-sid" => current_user.id, "data-rip" => user.id %></li>
																
															<% end %>
															
														<% end %>
													
													<% else %>
														
														<% User.get_admins.each do |user| %>
																
															<li><%= link_to user.first_name.to_s + " " + user.last_name.to_s, "#", class: "start-conversation", "data-sid" => current_user.id, "data-rip" => user.id %></li>
														
														<% end %>
														
													<% end %>
					
												</ul>
	
											</div><!--/ #tab-9-->
	
											<!-- - - - - - - - - - - - - - End tab - - - - - - - - - - - - - - - - -->
											
											<!-- - - - - - - - - - - - - - Tab - - - - - - - - - - - - - - - - -->
	
											<div id="conversations" class="tab_container">
											
											<ul class="conversation">
												
												<% if current_user.involving_conversations.count != 0 %>
												
													<% current_user.involving_conversations.each do |chat| %>
			
														<li class="animated_item <%= "unread_conversation" if current_user.unread_messages({conversation_id: chat.id}).count > 0 %>">
															
															<a href="#" class="start-conversation" data-sid="<%= current_user.id %>" data-rip="<%= chat.get_chatter(current_user).id %>" class="">
																<b><%= chat.get_chatter(current_user).first_name.to_s + " " + chat.get_chatter(current_user).last_name.to_s %>
																<% if current_user.unread_messages({conversation_id: chat.id}).count > 0 %>
              
																	(<span class="badge badge-info"><number><%= current_user.unread_messages({conversation_id: chat.id}).count %></number></span>)
																  
																<% end %>
															</b><br/>
																
																<p class="style_chat"><%= truncate(strip_tags(chat.get_new_message.body), length: 50) %></p>
															
															</a>
														
														</li>
														
													<% end %>
												
												<% else %>
													
													<li class="animated_item">
															
														<a href="#"><b>Bạn chưa có cuộc trò chuyện nào...</b></a>
														
													<li>
												
												<% end %>
											
											</ul>
	
											</div><!--/ #tab-7-->
	
											<!-- - - - - - - - - - - - - - End tab - - - - - - - - - - - - - - - - -->
	
										</div><!--/ .tab_containers_wrap -->
	
										<!-- - - - - - - - - - - - - - End of tabs containers - - - - - - - - - - - - - - - - -->
	
									</div><!--/ .tabs-->
									
									<!-- - - - - - - - - - - - - - End of tabs v2 - - - - - - - - - - - - - - - - -->
	
								</section><!--/ [col]-->
							
							<% else %>
								
								<section class="col-sm-12">

									<!-- - - - - - - - - - - - - - Tabs v2 - - - - - - - - - - - - - - - - -->
	
									<div class="tabs type_2">
	
										<!-- - - - - - - - - - - - - - Navigation of tabs - - - - - - - - - - - - - - - - -->
	
										<ul class="tabs_nav clearfix">
											
											<li><a href="#register"><i class="icon-user-md"></i></a></li>
											
											<li><a href="#login"><i class="icon-login-2"></i> Đăng nhập</a></li>
										</ul>
										
										<!-- - - - - - - - - - - - - - End navigation of tabs - - - - - - - - - - - - - - - - -->
	
										<!-- - - - - - - - - - - - - - Tabs container - - - - - - - - - - - - - - - - -->
	
										<div class="tab_containers_wrap">
	
											<!-- - - - - - - - - - - - - - Tab - - - - - - - - - - - - - - - - -->
	
											<div id="register" class="tab_container">
												
												<h3>Thông tin khách hàng</h3>
												
												<p>Bạn cần điền thông tin bên dưới để chat với quản trị viên.</p>
												<br />
	
												<%= form_for User.new, url: quick_register_path, html: {class: "type_2"} do |f| %>
													
													<ul>
											
														<li>
															
															<label for="login_email">Họ & Tên:</label>
															
															<%= f.text_field :first_name, autofocus: true, class: "form-control required" %>
														
														</li>
														
														<% if !Option.get_user_guest.nil? %>
															
															<% if Option.get_user_guest.accept_email == true %>
														
																<li>
																	
																	<label for="login_email">Email:</label>
																	
																	<%= f.email_field :email, class: "form-control required" %>
																
																</li>
																
															<% end %>
															
														<% end %>
														
														<li>
															
															<label for="login_email">Số điện thoại:</label>
															
															<%= f.text_field :phone, class: "form-control required" %>
														
														</li>
											
														<li class="v_centered">
															
															<input type="submit" value="Đăng ký" class="button_blue middle_btn">
														
														</li>
											
													</ul>
											
												<% end %>
											
												<%= render "/module/follow_facebook" %>
										
											</div><!--/ #tab-9-->
	
											<!-- - - - - - - - - - - - - - End tab - - - - - - - - - - - - - - - - -->
											
											<!-- - - - - - - - - - - - - - Tab - - - - - - - - - - - - - - - - -->
	
											<div id="login" class="tab_container">
												
												<h3>Đăng nhập</h3>
											
												<%= form_for(resource, as: resource_name, url: session_path(resource_name), html: {class: "type_2"}) do |f| %>
												
														<ul>
												
															<li>
																
																<label for="login_email">Địa chỉ email:</label>
																
																<%= f.email_field :email, autofocus: true, class: "form-control required", placeholder: "Nhập địa chỉ email..." %>
															
															</li>
												
															<li>
																
																<label for="login_password">Mật khẩu:</label>
																
																<%= f.password_field :password, autocomplete: "off", class: "form-control required", placeholder: "Nhập mật khẩu..." %>
															
															</li>
												
															<li class="v_centered">
																
																<%= button_tag "Đăng nhập", class: "button_blue middle_btn"%>
																
																<%= link_to "Quên mật khẩu?", { controller: "account", action: "forgotten" }, class: "small_link" %>
															
															</li>
												
														</ul>
												
													<% end %>
											
												<div class="streamlined">
											
													<!--Social icon's list-->
													<ul class="horizontal_list social_btns">
											
														<li><%= link_to '<i class="icon-facebook-1"></i><span class="tooltip top">Facebook</span>'.html_safe, user_omniauth_authorize_path(:facebook), class: "icon_btn middle_btn social_facebook tooltip_container" %></li>
														<li><%= link_to '<i class="icon-gplus-2"></i><span class="tooltip top">GooglePlus</span>'.html_safe, user_omniauth_authorize_path(:google_oauth2), class: "icon_btn middle_btn social_googleplus tooltip_container" %></li>
											
													</ul><!--/ .horizontal_list.wrapper.social_btns-->
													<!--End social icon's list-->
											
												</div><!--/ .streamlined-->
												<br /><br />
												<%= render "/module/follow_facebook" %>
	
											</div><!--/ #tab-7-->
	
											<!-- - - - - - - - - - - - - - End tab - - - - - - - - - - - - - - - - -->
	
										</div><!--/ .tab_containers_wrap -->
	
										<!-- - - - - - - - - - - - - - End of tabs containers - - - - - - - - - - - - - - - - -->
	
									</div><!--/ .tabs-->
									
									<!-- - - - - - - - - - - - - - End of tabs v2 - - - - - - - - - - - - - - - - -->
	
								</section><!--/ [col]-->
								
							<% end %>

						</div><!--/ .row -->

					</div><!--/ .section_offset -->

				</div><!--/ .container-->

			</div><!--/ .page_wrapper-->
			
			<!-- - - - - - - - - - - - - - End Page Wrapper - - - - - - - - - - - - - - - - -->
			
			<%= render "module/footer" %>

		</div><!--/ [layout]-->
		
		<!-- - - - - - - - - - - - - - End Main Wrapper - - - - - - - - - - - - - - - - -->
		
		<!-- Include Libs & Plugins
		============================================ -->
        <%= javascript_include_tag "/frontend/js/jquery-2.1.1.min.js" %>
        <%= javascript_include_tag "/frontend/js/queryloader2.min.js" %>
        <%= javascript_include_tag "/frontend/js/jquery.appear.js" %>
        <%= javascript_include_tag "/frontend/js/fancybox/source/jquery.fancybox.pack.js" %>
        <%= javascript_include_tag "/frontend/js/fancybox/source/helpers/jquery.fancybox-media.js" %>
        <%= javascript_include_tag "/frontend/js/fancybox/source/helpers/jquery.fancybox-thumbs.js" %>
        <%= javascript_include_tag "/frontend/js/owlcarousel/owl.carousel.min.js" %>
        <%= javascript_include_tag "/frontend/js/arcticmodal/jquery.arcticmodal.js" %>
        <%= javascript_include_tag "/frontend/twitter/jquery.tweet.min.js" %>
        <%= javascript_include_tag "/frontend/js/arcticmodal/jquery.arcticmodal.js" %>
        <%= javascript_include_tag "/frontend/js/colorpicker/colorpicker.js" %>
        <%= javascript_include_tag "/frontend/js/retina.min.js" %>
        <%= javascript_include_tag "http://s7.addthis.com/js/300/addthis_widget.js" %>

		<!-- Theme files
		============================================ -->
        <%= javascript_include_tag "/frontend/js/theme.plugins.js" %>
        <%= javascript_include_tag "/frontend/js/theme.core.js" %>
		<script>
            function resizeChatbox() {
                $(".chatboxcontent").height($(window).height()-152);
            }
			
			function startConversation(sender_id, recipient_id) {
				
				$.ajax({ url: '/conversations',
					type: 'POST',
					beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
					data: "sender_id=" + sender_id + "&recipient_id=" + recipient_id,
					success: function(data) {
						chatBox.chatWith(data.conversation_id);
					}
				});
			};
			
            $(window).resize(function(){
                resizeChatbox();
            });
			
			$(document).ready(function() {
				setInterval("resizeChatbox();", 1000);
				// start conversation
				<% if params[:sender_id].present? and params[:recipient_id].present? %>
					startConversation(<%= params[:sender_id] %>, <%= params[:recipient_id] %>)
				<% end %>
				<% if params[:chat_id].present? %>
					chatBox.chatWith(<%= params[:chat_id] %>);
					resizeChatbox();
				<% end %>
			})
			
        </script>
	</body>
</html>